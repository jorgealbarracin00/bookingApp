<!DOCTYPE html>
<html>
<head>
  <title>Admin ‚Äì Set Availability</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: 60px auto;
    }
    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #007aff;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>üìÖ Set Available Time Slots</h2>
  <% if (success) { %>
    <div style="background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
      ‚úÖ Time slots saved successfully!
    </div>
  <% } %>
  <% if (error) { %>
    <div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
      ‚ùå An error occurred while saving slots. Please try again.
    </div>
  <% } %>
  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
    <form method="GET" action="/admin/dashboard">
      <input type="hidden" name="weekOffset" value="<%= currentOffset - 1 %>">
      <button type="submit">‚Üê Previous Week</button>
    </form>
    <form method="GET" action="/admin/dashboard">
      <input type="hidden" name="weekOffset" value="<%= currentOffset + 1 %>">
      <button type="submit">Next Week ‚Üí</button>
    </form>
  </div>

  <form action="/admin/save" method="POST" id="slotForm">
    <input type="hidden" name="weekOffset" value="<%= currentOffset %>">
    <div style="margin-bottom: 10px;">
      <strong>Legend:</strong>
      <span style="margin-left: 10px; color: white; background-color: #4CAF50; padding: 2px 8px; border-radius: 4px;">Available</span>
      <span style="margin-left: 10px; color: white; background-color: #f44336; padding: 2px 8px; border-radius: 4px;">Unavailable</span>
      <span style="margin-left: 10px; color: white; background-color: #ff9800; padding: 2px 8px; border-radius: 4px;">Booked</span>
    </div>
    <div style="overflow-x: auto;">
      <table border="1" cellpadding="6" cellspacing="0">
        <thead>
          <tr>
            <th>Time</th>
            <% weekDays.forEach(day => { 
              const dayOfWeek = new Date(day.date).getDay();
              if (dayOfWeek === 0 || dayOfWeek === 6) return;
            %>
              <th style="<%= day.date === today ? 'background-color: #e0f7fa;' : '' %>">
                <%= day.label %><br><%= day.date %>
                <br><input type="checkbox" onclick="toggleDay('<%= day.date %>', this)">
              </th>
            <% }); %>
          </tr>
        </thead>
        <tbody>
          <% timeLabels.forEach(time => { 
            if (time > "17:00") return;
          %>
            <tr>
              <td><%= time %></td>
              <% weekDays.forEach(day => { 
                const dayOfWeek = new Date(day.date).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) return;
                const checked = slotMap[day.date]?.[time];
              %>
                <td style="text-align: center; <%= day.date === today ? 'background-color: #e0f7fa;' : '' %>">
                  <% if (checked === "booked") { %>
                    <span style="color: red; font-weight: bold;">Booked</span>
                    <br>
                    <button type="submit" name="deleteBooking" value="<%= day.date %>_<%= time %>" onclick="return confirm('Are you sure you want to delete this booking?')">Delete</button>
                  <% } else { %>
                    <button type="submit" name="slots_<%= day.date %>_<%= time %>" value="<%= checked === 'available' ? 'unavailable' : 'available' %>" style="width: 100%; padding: 6px; border: none; border-radius: 4px; background-color: <%= checked === 'booked' ? '#ff9800' : checked === 'available' ? '#4CAF50' : '#f44336' %>; color: white;" <%= checked === 'booked' ? 'disabled' : '' %>>
                      <%= checked === 'booked' ? 'Booked' : checked === 'available' ? 'Available' : 'Unavailable' %>
                    </button>
                  <% } %>
                </td>
              <% }); %>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <div style="margin-top: 10px;">
      <button type="submit">üíæ Save Slots</button>
    </div>
  </form>

  <script>
    function toggleDay(day, source) {
      document.querySelectorAll('input.slotBox.' + CSS.escape(day)).forEach(cb => {
        cb.checked = source.checked;
      });
    }

    function toggleAll(value) {
      document.querySelectorAll('.slotBox').forEach(cb => cb.checked = value);
    }
    setTimeout(() => {
      document.querySelectorAll('div[style*="background"]').forEach(el => el.remove());
    }, 4000);
  </script>
</body>
</html>