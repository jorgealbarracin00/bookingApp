<!DOCTYPE html>
<html>
<head>
  <title>Admin ‚Äì Set Availability</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: 60px auto;
    }
    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #007aff;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>üìÖ Set Available Time Slots</h2>
  <% if (success) { %>
    <div style="background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
      ‚úÖ Time slots saved successfully!
    </div>
  <% } %>
  <% if (error) { %>
    <div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
      ‚ùå An error occurred while saving slots. Please try again.
    </div>
  <% } %>
  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
    <form method="GET" action="/admin/dashboard">
      <input type="hidden" name="weekOffset" value="<%= currentOffset - 1 %>">
      <button type="submit">‚Üê Previous Week</button>
    </form>
    <form method="GET" action="/admin/dashboard">
      <input type="hidden" name="weekOffset" value="<%= currentOffset + 1 %>">
      <button type="submit">Next Week ‚Üí</button>
    </form>
  </div>

  <form action="/admin/save" method="POST" id="slotForm">
    <input type="hidden" name="weekOffset" value="<%= currentOffset %>">
    <div style="margin-bottom: 10px;">
      <strong>Legend:</strong>
      <span style="margin-left: 10px; color: white; background-color: #4CAF50; padding: 2px 8px; border-radius: 4px;">Available</span>
      <span style="margin-left: 10px; color: white; background-color: #f44336; padding: 2px 8px; border-radius: 4px;">Unavailable</span>
      <span style="margin-left: 10px; color: white; background-color: #ff9800; padding: 2px 8px; border-radius: 4px;">Booked</span>
    </div>
    <div style="overflow-x: auto;">
      <table border="1" cellpadding="6" cellspacing="0">
        <thead>
          <tr>
            <th>Time</th>
            <% weekDays.forEach(day => { 
              const dayOfWeek = new Date(day.date).getDay();
              if (dayOfWeek === 0 || dayOfWeek === 6) return;
            %>
              <th style="<%= day.date === today ? 'background-color: #e0f7fa;' : '' %>">
                <%= day.label %><br><%= day.date %>
                <br><input type="checkbox" onclick="toggleDay('<%= day.date %>', this)">
              </th>
            <% }); %>
          </tr>
        </thead>
        <tbody>
          <% timeLabels.forEach(time => { 
            if (time > "17:00") return;
          %>
            <tr>
              <td><%= time %></td>
              <% weekDays.forEach(day => { 
                const dayOfWeek = new Date(day.date).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) return;
                const checked = slotMap[day.date]?.[time];
              %>
                <td style="text-align: center; <%= day.date === today ? 'background-color: #e0f7fa;' : '' %>">
                  <% if (checked === "booked") { %>
                    <span style="color: red; font-weight: bold;">Booked</span>
                    <br>
                    <button type="submit" name="deleteBooking" value="<%= day.date %>_<%= time %>" onclick="return confirm('Are you sure you want to delete this booking?')">Delete</button>
                  <% } else { %>
                    <button
                      type="button"
                      class="slot-btn"
                      id="btn_<%= day.date %>_<%= time %>"
                      data-day="<%= day.date %>"
                      data-time="<%= time %>"
                      onclick="toggleSlot('<%= day.date %>', '<%= time %>')"
                      style="width: 100%; padding: 6px; border: none; border-radius: 4px; background-color: <%= checked === 'available' ? '#4CAF50' : '#f44336' %>; color: white; font-weight: bold;"
                    >
                      <%= checked === 'available' ? 'Available' : 'Unavailable' %>
                    </button>
                    <input
                      type="hidden"
                      name="slots_<%= day.date %>_<%= time %>"
                      id="input_<%= day.date %>_<%= time %>"
                      value="<%= checked === 'available' ? 'available' : 'unavailable' %>"
                    >
                  <% } %>
                </td>
              <% }); %>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <div style="margin-top: 10px;">
      <button type="submit">üíæ Save Slots</button>
    </div>
  </form>

  <script>
    // Toggle a single slot's button and hidden input
    function toggleSlot(day, time) {
      const btn = document.getElementById('btn_' + day + '_' + time);
      const input = document.getElementById('input_' + day + '_' + time);
      if (!btn || !input) return;
      // Toggle state
      if (btn.classList.contains('available')) {
        btn.classList.remove('available');
        btn.style.backgroundColor = '#f44336';
        btn.textContent = 'Unavailable';
        input.value = 'unavailable';
      } else {
        btn.classList.add('available');
        btn.style.backgroundColor = '#4CAF50';
        btn.textContent = 'Available';
        input.value = 'available';
      }
    }

    // Toggle all slots in a day column
    function toggleDay(day, source) {
      // Only look for slot buttons (not booked)
      document.querySelectorAll('button.slot-btn[data-day="' + day + '"]').forEach(btn => {
        const time = btn.getAttribute('data-time');
        const input = document.getElementById('input_' + day + '_' + time);
        if (!input) return;
        if (source.checked) {
          // Set to available
          btn.classList.add('available');
          btn.style.backgroundColor = '#4CAF50';
          btn.textContent = 'Available';
          input.value = 'available';
        } else {
          // Set to unavailable
          btn.classList.remove('available');
          btn.style.backgroundColor = '#f44336';
          btn.textContent = 'Unavailable';
          input.value = 'unavailable';
        }
      });
    }

    // Remove flash messages after 4s
    setTimeout(() => {
      document.querySelectorAll('div[style*="background"]').forEach(el => el.remove());
    }, 4000);

    // On page load, mark which slots are available
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('button.slot-btn').forEach(btn => {
        const day = btn.getAttribute('data-day');
        const time = btn.getAttribute('data-time');
        const input = document.getElementById('input_' + day + '_' + time);
        if (input && input.value === 'available') {
          btn.classList.add('available');
          btn.style.backgroundColor = '#4CAF50';
          btn.textContent = 'Available';
        } else {
          btn.classList.remove('available');
          btn.style.backgroundColor = '#f44336';
          btn.textContent = 'Unavailable';
        }
      });
    });
  </script>
</body>
</html>